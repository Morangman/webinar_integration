"use strict";window.$bizon_init_form=window.$bizon_init_form||function(e){var t,r=function(e,t){var r="string"==typeof e?document.querySelectorAll(e):e;if(r)for(var o=0;o<r.length;o++)t(r[o])},o=(e=e||{}).allowFormAction||!1,n={},i=0,s=0;e.domain=""+(e.domain||"start.bizon365.ru"),e.domain=e.domain.split("//").slice(-1).join("");var l="https://"+e.domain;if("localhost"==window.location.hostname.toString()&&(l=""),e.selectors=e.selectors||{},!e.selectors.form)return console.error("Не задан селектор формы!");if(!e.pageId&&!e.sublistId)return console.error("Не задан идентификатор рассылки!");var a=document.querySelectorAll(e.selectors.form),c=document.querySelectorAll(e.selectors.message),u="";if(a.length||console.log("Формы не найдены!"),r(a,(function(t){for(var r="email phone username".split(" "),o=0;o<r.length;o++){var n=r[o].trim();if(n){var i,s=e.form_fields[n];s&&(i="string"==typeof s?s:s.el,t.querySelector(i)||console.warn("Поле "+i+" не найдено"))}}t.addEventListener("submit",g)})),e.selectors.submitButton){var f=document.querySelectorAll(e.selectors.submitButton);r(f,(function(e){e.addEventListener("click",g)})),console.log("Обработчик onSubmit [selectors] повешен на кнопки: "+f.length)}function d(e){if(e=e||"",!c||!c.length){if(!e)return;return alert(e)}r(c,(function(t){t.innerHTML=e||""}))}function m(t,r,o){o||"function"!=typeof r||(o=r,r="");var n=new("onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest);n.open(t.method||"GET",t.url,!0);var i=r||"";if("POST"==t.method)if(i="",n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),"json"==e.dataType||"object"==typeof r)for(var s in r.url_marker=u,r)i&&(i+="&"),i+=s+"="+encodeURIComponent(r[s]);else i=r;n.onreadystatechange=function(){if(4==this.readyState){var e;try{e=window.JSON.parse(this.responseText)}catch(e){console.error("Некорректный ответ "+e.message)}if(e=e||{},200!=this.status){console.error(this.status+": "+this.responseText);var t={status:this.status,message:e.message||this.responseText||""};return o(t)}o(null,e)}},n.send(i)}e.form_fields.submitButton&&(f=document.querySelectorAll(e.form_fields.submitButton),r(f,(function(e){e.addEventListener("click",g)})),console.log("Обработчик onSubmit [form_fields] повешен на кнопки: "+f.length)),h(),e.pageId?m({method:"GET",url:l+"/form/"+e.pageId+"?format=json&rnd="+Date.now()},(function(o,l){if(!o){for(var a in l)n[a]=l[a];!function(){var e=n.now||0,t=new Date,r=(+t-e)/6e4;r+=-t.getTimezoneOffset()-180,r=(r/=60)<0&&-1<r?Math.round(r/60):Math.floor(r/60),i=r,console.log("deltaH: "+r)}();try{t=JSON.parse(n.schedule)}catch(o){t={}}!function(){var o,i;if(e.closestDateOnly&&n.days&&0<n.days.length){var l=n.days[0],a="",c="";l&&l.val&&(o=l.val,a=l.title,(i=t[o][0])&&(c=i.text,s=i.val||0)),function(t,o){t&&e.selectors.closestDate&&r(e.selectors.closestDate,(function(e){e.innerText=t})),o&&e.selectors.closestTime&&r(e.selectors.closestTime,(function(e){e.innerText=o}))}(a,c)}}(),p();var c=l.url_marker_name;if(c){var f=l.pageId+":"+c,d=S(f);!d&&b&&b[c]&&S(f,d=b[c]),d&&(console.log(c+"="+d),u=d)}}})):p();var v=!1;function g(t){if(!v){o||(t.preventDefault(),console.log("Штатная обработка формы отключена, т.к. параметр allowFormAction != true "));var n={email:{func:y,msg:"Укажите правильный e-mail"},phone:{func:_,msg:"Укажите ваш телефон"}};d();var c={},u=t.target,f=0,g="";for(var w in e.form_fields){var S,T=e.form_fields[w],q=!0;"string"==typeof T?S=T:(S=T.el,q=T.required);var I=u.querySelector(S);if(I){var M=(I.value||"").trim();if(q&&n[w]&&!n[w].func(M))return d(n[w].msg);c[w]=M}}if(Object.keys(c).length||r(a,(function(t){for(var r in e.form_fields)if(!c[r]){var o=e.form_fields[r],i=t.querySelector(o);if(!i)return g+="Не найдено поле "+r+". \n ",void f++;var s=(i.value||"").trim();if(n[r]&&!n[r].func(s))return g+=n[r].msg+" \n ",void f++;c[r]=s}})),!Object.keys(c).length)return d("Поля в форме не найдены");if(f)return console.log("Данные для отправки:",c),d(g=g||"Заполните обязательные поля");v=!0,c.time=s,c.timeoffset=i;var A="utm_source utm_medium utm_campaign utm_term utm_content utm_keyword utm_banner utm_phrase utm_group".split(" ");b&&A.forEach((function(e){var t=b[e]||"";t&&(c[e]=t)}));var R=l+"/subscriber/";e.pageId?R+=e.pageId+"/register":e.sublistId&&(R+="add",c.list=e.sublistId,c.uid=e.uid,c.field_email=c.email,c.field_name_first=c.username),h(),m({method:"POST",url:R,dataType:"json"},c,(function(t,r){if(v=!1,t)return console.error("Ошибка связи с сервером: ",t),setTimeout((function(){p()}),200),!o&&d("Ошибка "+t.status+": "+t.message);console.log("Ответ сервера: ",r),o||(e.redirectUrl||e.skipSuccessMessage||d(e.successMessage||"Успешная регистрация. Проверьте ваш почтовый ящик."),e.redirectUrl&&(e.redirectIntervalMs=+e.redirectIntervalMs||0,setTimeout((function(){window.location.href=e.redirectUrl}),e.redirectIntervalMs)))}))}}function h(){w(!0)}function p(){w(!1)}function w(e){e=e||!1,r(a,(function(t){var o=t.querySelectorAll("button");r(o,(function(t){t.disabled=e}))}))}function y(e){return/^[-\w.]+@([\w\-\_]+\.)+[A-z]{2,8}$/i.test(e)}function _(e){if(!e)return!1;var t=""+e;return!(!(t=(""+ +(t=t.replace(/[\s\(\)-]/gi,""))).trim())||!t.length||t.length<10)&&t}var b=function(){var e={};try{for(var t=window.location.search.slice(1).split("&"),r=0;r<t.length;r++){var o=t[r];if(o){var n=o.split("=");n[0]&&(e[n[0]]=decodeURIComponent(n[1]||""))}}}catch(t){e={}}return e}();function S(e,t){try{if(!window.localStorage)return;return void 0!==t&&(window.localStorage[e]=t),window.localStorage[e]}catch(e){console.error(e)}}};